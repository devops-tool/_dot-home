#!/usr/bin/env bash

# To-do:
# * learn to link .home/dot/**{!.inb?} files

############################################################

die()  { echo -e 2>&1 ".home ERROR:" "$@"; exit 1; }
warn() { echo -e 2>&1 ".home WARNING:" "$@"; }

set_dest_target() {
    local src="$1"      # relative to ~/.home/
    # non-local outputs:
    # $dest             relative to ~/
    # $target           relative to $(dirname dest/)

    dest="${src#*/}"
    dest="${dest/#dot\//.}"

    local slashes="${dest//[^\/]/}"    # Leave only slashes...
    target="${slashes//\//../}.home/$src"
}

############################################################

[ _"$1" = _--define-functions-only ] && { return 0; exit 0; }

mkdir -p "$HOME"/bin
cd "$HOME"/bin/ || die "Cannot change to $HOME/bin/."

# First pass, remove dangling links pointing into .home
for f in *; do
    [ -L "$f" ] || continue
    target="$(readlink "$f")"
    [ -z "${target##../.home/*}" ] || continue
    rm -f "$f"
done

for src in ../.home/*/bin/*; do
    [ -f "$src" ] \
        && { ln -s "$src" 2>/dev/null || warn "Conflict in bin/: $src"; }
done
